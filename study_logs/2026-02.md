# 2026年 2月 学習ログ

## 2026-02-01

### 取り組んだこと
- [光通信モールス信号受信デバイスの設計書](../projects/Apps/MorseLightReceiver/DESIGN.md)と実装計画を立てた
- [ジョイスティックモジュール](/projects/Apps/joystick-node/)とフォトレジスタの扱いを学んだ
- PID制御やギア比などについて学んだ

### 学んだこと・メモ

#### ジョイスティックモジュール

ジョイスティックは**2つのポテンショメータ**と**1つのスイッチ**で構成されている。

- X軸・Y軸の検知: スティックを倒すと、その角度に応じて内部の接触点が動き、抵抗値が変化する。これにより、出力される電圧が0-VCCで変化する。
- Z軸ボタンの検知: スティックを押すと、内部のスイッチがONになり、デジタル信号が出力される。

#### フォトレジスタ (CdSセル) の仕組み

**硫化カドミウム**という半導体でできている。
- **暗い時**: 電子が動きにくく、電気を通しにくい状態。つまり**抵抗値が高い**状態。
- **明るい時**: 光エネルギーを受けると、内部の電子が活発に飛び出し、電気が流れやすい状態。つまり**抵抗値が低い**状態。

#### 分圧回路による変換

ArduinoのA0ピンは電圧しか読めないため、この**抵抗値の変化**を**電圧の変化**に変換する必要がある。そのために、固定抵抗 (10kΩ) と直列につなぎます。

電圧は、2つの抵抗の比率で分け合われる。
`A0の電圧 = 5V × (固定抵抗 / (フォトレジスタ抵抗 + 固定抵抗))`

**具体的な変化の例:**
- **暗い時 (フォトレジスタ = 100kΩ とする)**
  - 100kΩ(大) と 10kΩ(小) で分け合うため、5Vのほとんどはフォトレジスタ側にかかり、A0地点に来る電圧は小さくなる。
  - 計算: `5V × (10k / 110k) ≒ 0.45V` (Arduinoでは `100` くらいの低い値)
- **明るい時 (フォトレジスタ = 1kΩ とする)**
  - 1kΩ(小) と 10kΩ(大) で分け合うため、A0地点には大きな電圧が来る。
  - 計算: `5V × (10k / 11k) ≒ 4.5V` (Arduinoでは `900` くらいの高い値)

この原理により、「光が当たると数値が上がる」という仕組みを作る。

#### 減速比

DCモーターは通常、1分間に数千~数万回転(rpm)という高速で回転するが、トルクは弱い。そこで、**ギアボックス**を使って減速する。

$$
\text{減速比} = \frac{\text{入力ギアの歯数}}{\text{出力ギアの歯数}}
$$

実際、タイヤつきロボット動かすとき、タイヤを回すのに大きな力が必要になる。この時のモーターは、普段の数倍~10倍もの電流(ストール電流)が必要になるため、電圧降下でマイコンの電源が落ちてしまうことがある。これを防ぐために**電源分離**といって、マイコン用(9V電池)とモーター用(乾電池4本直列)の電源を分けることがある。

### 次回の取り組み
モールス信号受信デバイスを完成させたい。Tinkercadでシミュレーションは出来たので、あとは配線するのみ。

電子工作、出来るようにはなってきたが、まだ「勘」のようなものが養っていない気がする。例えば、この素子をつないだ時だいたいどのくらいの抵抗を繋げればいいのかとか...

## 2026-02-02

### 取り組んだこと
- モールス信号受信デバイスの完成
- バイポーラトランジスタやMOSFETについての勉強
- オペアンプの勉強

### 学んだこと・メモ

#### 抵抗の選び方
LED抵抗の場合は、220-470Ωだとしっかり光る。1kΩだとまぶしくない程度に光る。

プルアップ抵抗に関しては、**10kΩ**が一般的。電流の無駄遣いが少ないため。ただ、Arduinoの場合には内部プルアップがあるので、抵抗は必須ではない。

続いて、トランジスタ。トランジスタは、ベースに電圧をかけると、エミッタからコレクタへ電流が流れる。このとき、Arduinoとベースの間にはとりあえず**1kΩ**の抵抗を入れておけば間違いない。もしこれで動かなかったら、抵抗を330Ωに下げる。

#### バイポーラトランジスタとMOSFET

1. バイポーラトランジスタ
- 電流制御
- ベースに流し込む**小さな電流**を使用して、コレクタからエミッタに流れる**大きな電流**を制御する。
- 昔からあり、安価。増幅回路に向いているが、ベースに常に電流を流し続ける必要があるため、電力ロスが発生する。

![バイポーラトランジスタ](/study_logs/images/BJT.jpg)

2. MOSFET
- 電圧制御
- ゲートに**電圧**をかけることで、ドレインからソースへの電流を制御する。
- **ゲートは絶縁されている**ため、一度電圧をかければ電流を流し続ける必要はほとんどない。

![MOSFET](/study_logs/images/MOSFET.jpg)

2.1 ゲートしきい値電圧

ゲートに何ボルトかけたら、ドレイン・ソース間に電流が流れ始めるか。Arduino(5V)では、1.0-2.5V程度のものを選ぶ。**ロジックレベル**と書かれたMOSFETを選ぶ。

2.2 オン抵抗

スイッチが完全にオンになったときの、ドレイン・ソース間の抵抗値。小さいほど熱くならない。

Q. Arduinoを使用して「12Vで動作し、2Aの電流が流れるDCモーター」をON/OFF制御する回路を作る。このとき、汎用バイポーラトランジスタとMOSFETのどちらを使うべきか？

A. MOSFETを使うべき。

$h_{fe}=100$とすると、$I_B=\frac{I_C}{h_{fe}=20mA}$になり、Arduinoのピン1本から出せる電流の上限ギリギリ。

#### オペアンプ
電源端子を除くと主に3本の端子がある。
- $V_+$: 非反転入力端子
- $V_-$: 反転入力端子
- $V_{out}$: 出力端子
$V_+$と$V_-$のわずかな電圧の差分を見つけて、その差分を増幅して出力する。R1は接地抵抗、R2はフィードバック抵抗。以下の2つの性質がある。

- 入力端子に電流は流れ込まない: **入力インピーダンスが無限**のため。
- イマジナリーショート: 出力から入力へ負帰還がかかっているとき、出力電圧と入力電圧が等しくなるように調整する。

1. 非反転増幅回路

入力した信号と同じ向きで大きくする回路。センサーの値を大きくするのに最も使われる。

$$A_v=1+\frac{R_2}{R_1}$$

2. 反転増幅回路

入力した信号とプラスマイナスが逆になって出力される回路。

$$A_v=-\frac{R_2}{R_1}$$


#### IR Receiver Module
ピン配置は、以下のとおり。
- G: GND
- R: VCC
- Y: OUT(任意のピン)

IR Receiver Moduleを使用するときは、`IRremote.hpp`をインクルードする。

#### RGB LED
RGB LEDのピンの見分け方は脚の長さを基準に以下のようにつなぐ。
- 中間の脚: Red
- 一番長い: GND
- 中間の脚: Green
- 一番短い: Blue

## 2026-02-03

### 取り組んだこと
- ロボットカー製作の発注と設計書を作成
- テスター、はんだごてを購入
- KiCadを学んだ

### 学んだこと・メモ

#### モータードライバー

モータに乾電池を接続するだけだと、モータはその乾電池の電圧に応じて、最大速度で回転するだけになる。
モータードライバーを使用することで、回転方向を正転・逆転と2方向にできたり、回転スピードを好きなように設定したりと自在にモーターが制御できるようになる。

モーターの正逆転は、**Hブリッジ**という回路を組むことで実現できる。

![Hブリッジ](/study_logs/images/Hブリッジ.png)

#### モータードライバーIC

モータードライバー回路を構成するのに必要とされる**MOSトランジスタによるHブリッジ**、**電流制限回路**、**過熱保護回路**などを1つのチップに集積したものが**モータードライバーIC**である。

#### KiCad
1. 回路図エディタ

![回路図エディタ](/study_logs/images/回路図エディタ.png)

どのピンとどのピンが繋がっているかという**ネットリスト**を作ることが目的。
- シンボル配置: 素子などのコンポーネントを配置する
- ラベル: 長い配線の場合、同じラベルを付けたピン同士は接続されているとみなされる
- ERC: 出力ピン同士がぶつかっていないか、電源がどこにもつながっていないピンはないかをチェックする

2. フットプリントの割り当て

回路図上の素子を**実際に買う部品の形**と結び付ける作業。

3. PCBエディタ

![PCBエディタ](/study_logs/images/PCBエディタ.png)

3.1 レイヤー
基盤は**サンドイッチ構造**になっている。KiCadの画面右側にあるレイヤーマネージャーで切り替えて操作する。
| レイヤー名 | 役割 | 備考 |
| :--- | :--- | :--- |
| F.Cu / B.Cu | 表/裏の銅箔層 | 実際に電気が流れる道。メインの配線。 |
| F.Adhes / B.Adhes | 接着剤層 | 表面実装部品を固定するため。通常はあまり使わない。 |
| F.SilkS / B.SilkS | シルク図 | 基板上の文字やロゴ。「R1」「ESP32」などの印字。 |
| F.Mask / B.Mask | レジスト層 | 銅箔を保護するコーティング。ハンダ付けする場所だけ窓を開ける。 |
| Edge.Cuts | 基板外形 | 基板の形。 四角だけでなく、円形や複雑な形も可能。 |

3.2 配線とビア
部品のピン同士を銅箔の線でつなぐ。
- 配線幅: **電流がたくさん流れる場所は太く**、**信号線は補足する**のが基本。
- ビア: 表側の配線が行き止まりになったとき、裏側に逃がすための**トンネル**
- ラッツネスト: まだ繋がっていないピン同士を結ぶ**細いガイド線**。これがすべて消えれば配線完了。

3.3 ベタGNDの作成
基盤の空いているスペースをすべてGNDの銅箔で埋め尽くす。
**ノイズ耐性の向上**や**インピーダンスの安定**ができる。

3.4 DRC
最後に実行するのがDRC。
- 線と線が近すぎてショートしていないか？
- 穴のサイズが製造メーカの限界より小さくない？
- 回路図では繋がっているのに、基盤でつなぎ忘れている箇所はないか？

4. 3Dビューアー

![3Dビューアー](/study_logs/images/3Dビューアー.png)

### 次やること
KiCadの基礎を学んだので、次は実際に基盤を発注してみたい。

## 2026-02-05

### 取り組んだこと
- ロボットカーの車体製作
- 足りなくなった部品・追加モジュールの発注

### 学んだこと・メモ

#### 車体製作

ひとまず、車体のフレーム・モーター取付・ブレッドボードに部品配置まで完了。ブレッドボード同士を連結・分割できることを初めて知った。また、ESP32の取り付け位置を間違ったせいでUSBを差せなくなった...

![車体](/study_logs/images/ロボット車体.jpg)

### 次やること
配線を終わらせ、ロボットを完成させる。出来れば、ライントレース・液晶モジュールを加えたい。

## 2026-02-08
### 取り組んだこと
- モータードライバのはんだづけ
- 配線整理
### 学んだこと・メモ
**フラックス**を用いると圧倒的にはんだづけしやすい！芋はんだになりにくい。
### 次やること
ソフトウェアの製作を行う。ロボットカーを完成させる。

## 2026-02-09
### 取り組んだこと
- ロボットカー完成
### 学んだこと・メモ
はじめの方はうまくいったが、書き込みを繰り返すうち、 `Brownout detector was triggered` というログが表示された。
#### Brownout Reset
シリアルモニタに `Brownout detector was triggered` と表示される場合、「供給電圧が足りなくて、動作が不安定になる前に自分でリセットしている状態」を意味する。これは**新品の電池でも起こる**

- 通信開始時に瞬間的に大きな電流が流れる
- 細すぎる・長すぎるケーブルの抵抗により、デバイスに届くまで電圧が下がってしまう
- モーターやセンサーなどをマイコンと同じ電源線から動かしている

ことが原因だと考えられる。

対策としては、**ハードウェア周り**を見直す必要がある。具体的には、

- 電源を分ける: ESP32はモバイルバッテリー(USB)で給電し、乾電池はモーター専用にする。
- コンデンサを追加: ESP32のGNDと5V(または3.3V)の間に、大きめの電解コンデンサ(100µF〜1000µF)を入れる。
- 配線を見直す: 電源ラインの配線を太く短くする。ブレッドボードを使っている場合は接触抵抗が高いので特に注意。

### 次やること
電源を分けようと思う。しかし、電源を2つ用意するとなるとロボットを拡張する必要が出てきた。スペーサーなどを秋月で買い、CADで車体をデザインする。CADの知識が皆無なので、しばらくはCADの勉強に専念したい。